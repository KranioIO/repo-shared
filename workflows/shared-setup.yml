# .github/workflows/shared-setup.yml
name: shared-setup
description: Common setup (branch detection + azure login)

on:
  workflow_call:
    secrets:
      AZURE_CREDENTIALS:
        required: true
    outputs:
      env_name:
        description: "Target environment (dev/qa/prd)"
        value: ${{ jobs.shared.outputs.env_name }}
      suffix:
        description: "Environment suffix (_dev/_qa/_prd)"
        value: ${{ jobs.shared.outputs.suffix }}

jobs:
  shared:
    runs-on: ubuntu-latest
    outputs:
      env_name: ${{ steps.set_env.outputs.env_name }}
      suffix: ${{ steps.set_env.outputs.suffix }}

    steps:
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Extract environment from branch
        id: set_env
        run: |
          BRANCH="${{ github.ref_name }}"
          echo "Detected branch: $BRANCH"

          if [[ "$BRANCH" == "dev" || "$BRANCH" == "publish/dev" ]]; then
            echo "env_name=dev" >> $GITHUB_OUTPUT
            echo "suffix=_dev" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == release/* ]]; then
            echo "env_name=qa" >> $GITHUB_OUTPUT
            echo "suffix=_qa" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == "master" ]]; then
            echo "env_name=prd" >> $GITHUB_OUTPUT
            echo "suffix=_prd" >> $GITHUB_OUTPUT
          else
            echo "Unknown branch: $BRANCH"
            exit 1
          fi
